<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<video id="video" data-control="" style="width: 800px;">
    <source id="videoSrc" type="video/mp4">
</video>

<audio id="audio" data-control=""></audio>
<audio id="ticktock"></audio>

<script>
    let socket = io();
    let video = document.getElementById('video');
    let audio = document.getElementById('audio');
    let ticktock = document.getElementById('ticktock');
    let videoSrc = document.getElementById('videoSrc');
    let controls = {
        video, audio, ticktock, videoSrc
    };

    async function play(obj) {
        try {
            await obj.load();
            await obj.play();
        } catch(err) {}
    }

    ['video', 'audio'].forEach(function(which) {
        ['loaded', 'playing', 'ended'].forEach(function(eventName) {
            controls[which].addEventListener(eventName, (e) => {
                //console.log(`event ${eventName} on ${which}`);
                socket.emit(`${which}-${eventName}`, JSON.parse(e.target.getAttribute('data-control')));
            });
        });
        socket.on(`${which}-start`, function(data){
            //console.log(`start the ${which}`);
            controls[which].setAttribute('data-control', JSON.stringify(data));
            let ctrl = (which === 'video') ? 'videoSrc' : 'audio';
            controls[ctrl].setAttribute('src', `${which}/${data.id}.${data.format}`);
            if (ctrl == 'videoSrc') {
                controls[ctrl].setAttribute('type', `video/${data.format}`);
            }
            play(controls[which]).then(function(){
                //console.log(`${which} is starting`);
            });
        });
    });
</script>

</body>
</html>