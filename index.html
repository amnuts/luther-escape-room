<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="/config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<video id="video" data-control="" style="width: 800px;" src="" type="video/mp4"></video>
<audio id="audio" data-control="" src="" type="audio/mp3"></audio>
<audio id="ticktock" src="audio/ticking.mp3" type="audio/mp3" loop></audio>
<audio id="buzzer" src="audio/buzzer.mp3" type="audio/mp3"></audio>

<script>
    let socket = io();
    let video = document.getElementById('video');
    let audio = document.getElementById('audio');
    let ticktock = document.getElementById('ticktock');
    let buzzer = document.getElementById('buzzer');
    let controls = { video, audio };

    async function playMe(obj) {
        try {
            await obj.load();
            await obj.play();
        } catch(err) {}
    }

    ['video', 'audio'].forEach(function(which) {
        ['loaded', 'playing', 'ended'].forEach(function(eventName) {
            controls[which].addEventListener(eventName, (e) => {
                //console.log(`event ${eventName} on ${which}`);
                socket.emit(`${which}-${eventName}`, JSON.parse(e.target.getAttribute('data-control')));
                if (eventName === 'ended') {
                    ticktock.volume = config.ticktock.max;
                }
            });
        });
        socket.on(`${which}-start`, function(data){
            //console.log(`start the ${which}`);
            ticktock.volume = config.ticktock.min;
            controls[which].setAttribute('data-control', JSON.stringify(data));
            controls[which].setAttribute('src', `${which}/${data.id}.${data.format}`);
            controls[which].setAttribute('type', `${which}/${data.format}`);
            playMe(controls[which]).then(function(){
                //console.log(`${which} is starting`);
            });
        });
    });

    socket.on(`ticktock-max`, function(data){
        console.log('ticktock-max event');
        console.dir(data);
        ticktock.volume = config.ticktock.max;
    });

    // start the ticking clock

    ticktock.volume = config.ticktock.max;
    console.dir(ticktock);
    let ttPromise = ticktock.play();

    if (ttPromise !== undefined) {
        ttPromise.then(_ => {
            console.log('playing ticktock');
        })
        .catch(error => {
            console.log('cannot play ticktock');
            console.dir(error);
        });
    }
</script>

</body>
</html>